<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Stock Visualizer</title>
	<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">    
	<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='stocks.css')}}">
    	<script src='https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.33.1/plotly.min.js'></script>
	<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>
	<script>
		function Round(x,n) {
			var mult = Math.pow(10,n);
			return Math.round(mult*x)/mult
		}
		function GetInc(data,interval) {
			var s = data.length;
			var t = Math.round(interval);
			var inc = []
			for(var i=0; i<s-t; i++) 
				inc.push(data[i+t]/data[i]);
			return inc;
		}
		function Mean(data) {
			var sum = 0;
			for(var i=0; i<data.length; i++) 
				sum += data[i];
			sum /= data.length;
			return sum;
		}
		function Std(data,mean) {
			ss = 0;
			for(var i=0; i<data.length; i++) 
				ss += (data[i]-mean)*(data[i]-mean);
			ss /= data.length;
			ss = Math.sqrt(ss);
			return ss;
		}
		function GetLogInc() {
			var log_inc = [];
			for(var i=0; i<INC.length; i++) 
				log_inc[i] = Math.log(INC[i]);
			return log_inc;
		}
		function LogMean() {
			return Math.exp(Mean(LOG_INC));
		}
		function Graph(bins) {
			var trace = {
				x: INC,
				type: 'histogram',
				xbins: {
					end: MEAN + 3*STD,
					size: 6*STD / bins,
					start: MEAN - 3*STD
				}
			};
			var data = [trace];
			var layout = {
				xaxis: {
					tickfont: {
						size: 18
					}
				},
				yaxis: {
					showticklabels: false,
                    showgrid: false
				},
				layout: {
					autosize: true,
				}
			};
			$('#title').text('{{ Ticker }}:');
			$('#mean').text(Round(MEAN,4));
			$('#std').text(Round(STD,4));
			$('#cs').text(Round((MEAN-1)/STD,4));
			$('#logMean').text(Round(LOG_MEAN,4));

			Plotly.newPlot('graph',data,layout,{displayModeBar: false});
		    
        }
		function Logslider(pos,min,max) {
			var pos = Number(pos);
		  	var minVal = Math.log(min);
		  	var maxVal = Math.log(max);

		  	var scale = (maxVal-minVal) / (MAX_POS-MIN_POS);

  			var val = Math.exp(minVal + scale*(pos-MIN_POS));
			
			// make nearest value to a year be exactly a year
			var nearestYear = Math.floor(val/365.25);
			if(365.25*(nearestYear+1)-val < val-365.25*nearestYear)
				nearestYear++;
			if(nearestYear == 0)
				return Math.round(val);
			var last = Math.exp(minVal + scale*(pos-1-MIN_POS));
			var next = Math.exp(minVal + scale*(pos+1-MIN_POS));
			var lastDist = Math.abs(last-365.25*nearestYear);
			var nextDist = Math.abs(next-365.25*nearestYear);
			var dist = Math.abs(val-365.25*nearestYear);
			if(dist < lastDist && dist < nextDist)
				return 365.25*nearestYear;
			return Math.round(val);
		}
		function LogsliderInverse(val,min,max) {
			var val = Number(val);
		  	var minVal = Math.log(min);
		  	var maxVal = Math.log(max);

		  	var scale = (maxVal-minVal) / (MAX_POS-MIN_POS);
			
			var pos = (Math.log(val) - minVal)/scale + MIN_POS;
			if(pos > max)
				return max;
			return Math.round(pos);
		}
		var ChangeInterval = function(param) {
			if(param.data.initial != 'false') 
				$('#interval').val(INTERVAL_POS);
		
			interval = Logslider($('#interval').val(),1,HIST.length);	

			INC = GetInc(HIST,interval);
			MEAN = Mean(INC);
			STD = Std(INC,MEAN);
			LOG_INC = GetLogInc();
			LOG_MEAN = LogMean();

			var years = Math.floor(interval / 365.25);
			var days = Math.round(interval - 365.25*years);
			
			$('#intervalVal').text(years + ' y ' + days + ' d');
			$('#intervalHidden').val(interval);
			Graph(bins);
		}
		var ChangeBins = function(param) {
			if(param.data.initial != 'false')
				$('#bins').val(BINS_POS);
			
			bins = Logslider($('#bins').val(),10,1000);		
			bins = Math.round(bins)


			$('#binVal').text(bins);
			$('#binsHidden').val($('#bins').val());
			Graph(bins);
		}

	</script>	
  </head>
  <body>
	<center>
    <div id='beforeGraph'>
		<h1>Histogram of Stock Growth</h1>
		<form action='' method='POST'>
			<input type='hidden' name='Interval', id='intervalHidden'>
			<input type='hidden' name='Bins' id='binsHidden'>
			<span>Ticker: </span><input type='text' name='Ticker'> 
			<input type='submit' value='Graph'>
		</form>	
		<h2 id='title'></h2>
		<span>
		<table border='1'>
			<tr>
				<th>Mean</th><th>Log-Mean <a href='{{ url_for('questions') }}'>?</a></th><th>Std</th><th>Profit/Std</th>
			</tr>
			<tr>
				<td id='mean'></td><td id='logMean'></td><td id='std'></td><td id='cs'</td>
			</tr>
		</table>
		</span>
    </div>
    <div id='graph'></div>
    <div id='afterGraph'>
        <span>Time Interval:</span> 
        <span id='intervalVal'></span>
        <br>
        <input type='range' id='interval'>
        <br><br>
        <span>Bins:</span> 
        <span id='binVal'></span>
        <br>
        <input type='range' id='bins'>	
        <script>
            var INC, MEAN, STD, LOG_INC, LOG_MEAN;

            var MIN_POS = 0;
            var MAX_POS = 1000;

            $('#interval').attr({
                'min': MIN_POS,
                'max': MAX_POS
            });
            $('#bins').attr({
                'min': MIN_POS,
                'max': MAX_POS
            });

            var HIST = {{ historical }};
            var INTERVAL_POS = LogsliderInverse({{ interval }},1,HIST.length);	
            var BINS_POS = {{ bins }};
            $(document).ready(ChangeInterval);
            $('#interval').on('input', {initial:'false'}, ChangeInterval);

            $(document).ready(ChangeBins);
            $('#bins').on('input', {initial:'false'}, ChangeBins);
            
        </script>
        <br><br>
        <button id='home' onclick="location.href='{{ url_for("questions") }}'" type='button'>Questions?</button>
        <button id='home' onclick="location.href='{{ url_for("home") }}'" type='button'>Home Page</button>
    </div>
  </body>
</html>
